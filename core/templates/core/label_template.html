<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=TikTok+Sans:opsz,wght@12..36,300..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto:wght@400&display=swap" rel="stylesheet">
    <title>Print Label - {{ sku }}</title>
    <style>
        @page {
            width: 30mm;
            height: 20mm;
            margin: 0;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            background: #fff;
        }

        .preview-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }

        .label-wrapper {
            width: 30mm;
            height: 20mm;
            position: relative;
            padding: 0;
            transform-origin: center;
        }

        @media screen {
            .label-wrapper {
                transform: scale(3);
            }
        }

        @media print {
            .label-wrapper {
                transform: none !important;
            }
        }

        .company-name {
            font-family: 'Montserrat', Arial, sans-serif;
            font-weight: 500;
            font-size: 6pt;
            position: absolute;
            top: 1mm;
            left: 1mm;
            right: 1mm;
            height: 2mm;
            line-height: 2mm;
            text-align: center;
        }

        .barcode-container {
            position: absolute;
            top: 3mm;
            left: 1mm;
            right: 1mm;
            height: 8.5mm;
            text-align: center;
        }

        canvas.barcode-image {
            width: 100%;
            height: auto;
            max-height: 10mm;
            object-fit: contain;
        }

        .sku-text {
            height: 1.5mm;
            line-height: 1.5mm;
            font-size: 5pt;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-top: -0.7mm;
        }

        .item-name-container {
            position: absolute;
            top: 12mm;
            left: 1mm;
            right: 1mm;
            bottom: 1mm;
            height: 3.5mm;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            display: flex;
        }

        .item-name {
            font-family: 'Tiktok Sans', Arial, sans-serif;
            font-weight: 300;
            font-size: 6.5pt;
            line-height: 1.5mm;
            text-align: center;
            max-height: 100%;
            overflow-wrap: break-word;
            word-break: break-word;
            white-space: normal;
        }

        .price {
            font-family: 'Tiktok Sans', Arial, sans-serif;
            font-weight: 300;
            font-size: 14pt;
            color: #000;
            position: absolute;
            top: 16mm;
            left: 1mm;
            right: 1mm;
            height: 3mm;
            line-height: 3mm;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="preview-container">
        <div class="label-wrapper">
            <div class="company-name">{{ company_name }}</div>

            <div class="barcode-container">
                <canvas id="barcode" class="barcode-image"></canvas>
            </div>

            <div class="item-name-container">
                <div class="item-name">{{ item_name }}</div>
            </div>

            <div class="price">Php {{ price }}</div>
        </div>
    </div>

    <!-- bwip-js (browser build) -->
    <script src="https://unpkg.com/bwip-js/dist/bwip-js-min.js"></script>

    <script>
    function adjustPriceFont() {
        const priceElem = document.querySelector(".price");
        let fontSize = 14;
        priceElem.style.fontSize = fontSize + "pt";
        priceElem.style.whiteSpace = "nowrap";
        const parentWidth = priceElem.offsetWidth;

        while (priceElem.scrollWidth > parentWidth && fontSize > 6) {
            fontSize -= 0.5;
            priceElem.style.fontSize = fontSize + "pt";
        }

        if (priceElem.scrollWidth > parentWidth) {
            priceElem.style.whiteSpace = "normal";
            priceElem.style.lineHeight = "1.1";
            while ((priceElem.scrollHeight > priceElem.offsetHeight) && fontSize > 5) {
                fontSize -= 0.5;
                priceElem.style.fontSize = fontSize + "pt";
            }
        }
    }

    function adjustItemNameFont() {
        const nameElem = document.querySelector(".item-name");
        const container = nameElem.parentElement;
        if (!nameElem || !container) return;

        let fontSize = 6;
        const minFontSize = 4.5;
        nameElem.style.fontSize = fontSize + "pt";
        nameElem.style.whiteSpace = "normal";
        nameElem.style.lineHeight = "1.8mm";

        while (
            (nameElem.scrollHeight > container.clientHeight || nameElem.scrollWidth > container.clientWidth) &&
            fontSize > minFontSize
        ) {
            fontSize -= 0.25;
            nameElem.style.fontSize = fontSize + "pt";
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const sku = "{{ sku }}";
        const canvas = document.getElementById("barcode");

        // Adjust canvas resolution for thermal printer (e.g. 300 DPI)
        const mmToInch = 0.0393701;
        const dpi = 300;
        const labelWidthMM = 28;  // usable barcode area
        const labelHeightMM = 10;

        // Physical canvas size in pixels
        canvas.width = Math.floor(labelWidthMM * mmToInch * dpi);
        canvas.height = Math.floor(labelHeightMM * mmToInch * dpi);

        // Render barcode with higher resolution
        try {
            bwipjs.toCanvas(canvas, {
                bcid:        'ean13',
                text:        sku,
                scaleX:      12,          // Increase thickness
                scaleY:      12,          // Increase height
                height:      8,         // in millimeters (bwip handles this)
                includetext: true,
                textxalign:  'center',
                textsize:    8,         // Text size in points
                paddingwidth: 0,
                paddingheight: 0,
                monochrome: true,
            });
        } catch (e) {
            console.error("Barcode generation failed:", e);
        }

        adjustPriceFont();
        adjustItemNameFont();
    });
    </script>
</body>
</html>
